!function(n){var e={};function r(t){if(e[t])return e[t].exports;var a=e[t]={i:t,l:!1,exports:{}};return n[t].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=n,r.c=e,r.d=function(n,e,t){r.o(n,e)||Object.defineProperty(n,e,{configurable:!1,enumerable:!0,get:t})},r.n=function(n){var e=n&&n.__esModule?function(){return n.default}:function(){return n};return r.d(e,"a",e),e},r.o=function(n,e){return Object.prototype.hasOwnProperty.call(n,e)},r.p="./",r(r.s=11)}([function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__math_js__ = __webpack_require__(2);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__BoundingBox_js__ = __webpack_require__(23);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2__AudioBoard__ = __webpack_require__(8);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_3__EventEmitter__ = __webpack_require__(24);\n\r\n\r\n\r\n\r\n\r\nconst Sides = {\r\n    LEFT: Symbol(\'left\'),\r\n    RIGHT: Symbol(\'right\'),\r\n    BOTTOM: Symbol(\'bottom\'),\r\n    TOP: Symbol(\'top\')\r\n};\n/* harmony export (immutable) */ __webpack_exports__["a"] = Sides;\n\r\n\r\nclass Trait {\r\n    constructor(name) {\r\n        this.NAME = name;\r\n\r\n        this.events = new __WEBPACK_IMPORTED_MODULE_3__EventEmitter__["a" /* default */]()\r\n        this.tasks = [];\r\n    }\r\n\r\n    finalize() {\r\n        this.tasks.forEach(task => task());\r\n        this.tasks.length = 0;\r\n    }\r\n\r\n    queue(task) {\r\n        this.tasks.push(task);\r\n    }\r\n\r\n    collides(us, them) {\r\n        // console.log(\'Collides with \', them);\r\n    }\r\n\r\n    obstruct() {\r\n\r\n    }\r\n\r\n    update() {\r\n        // console.warn(\'Unhandled update call in Trait\')\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["b"] = Trait;\n\r\n\r\nclass Entity {\r\n    constructor() {\r\n        this.canCollides = true;\r\n\r\n        this.audio = new __WEBPACK_IMPORTED_MODULE_2__AudioBoard__["a" /* default */]()\r\n        this.sounds = new Set()\r\n        this.pos = new __WEBPACK_IMPORTED_MODULE_0__math_js__["b" /* Vec2 */](0,0);\r\n        this.vel = new __WEBPACK_IMPORTED_MODULE_0__math_js__["b" /* Vec2 */](0,0);\r\n        this.size = new __WEBPACK_IMPORTED_MODULE_0__math_js__["b" /* Vec2 */](0,0);\r\n        this.offset = new __WEBPACK_IMPORTED_MODULE_0__math_js__["b" /* Vec2 */](0,0);\r\n        this.bounds = new __WEBPACK_IMPORTED_MODULE_1__BoundingBox_js__["a" /* default */](this.pos, this.size, this.offset);\r\n        this.lifeTime = 0;\r\n\r\n        this.traits = [];\r\n    }\r\n\r\n    playSounds(audioBoard, audioContext) {\r\n        this.sounds.forEach(name => {\r\n            audioBoard.playAudio(name, audioContext)\r\n        })\r\n        this.sounds.clear()\r\n    }\r\n\r\n    addTrait(trait) {\r\n        this.traits.push(trait);\r\n        this[trait.NAME] = trait;\r\n    }\r\n\r\n    finalize() {\r\n        this.traits.forEach(trait => {\r\n            trait.finalize();\r\n        })\r\n    }\r\n\r\n    collides(candidate) {\r\n        // console.log(\'Touched\', candidate);\r\n        this.traits.forEach(trait => {\r\n            trait.collides(this, candidate);\r\n        })\r\n    }\r\n\r\n    obstruct(side, match) {\r\n        this.traits.forEach(trait => {\r\n            trait.obstruct(this, side, match);\r\n        })\r\n    }\r\n\r\n    draw() {\r\n\r\n    }\r\n\r\n    update(gameContext, level) {\r\n        this.traits.forEach(trait => {\r\n            trait.update(this, gameContext, level);\r\n        });\r\n\r\n        this.playSounds(this.audio, gameContext.audioContext)\r\n\r\n        this.lifeTime += gameContext.deltaTime;\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["c"] = Entity;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/Entity.js\n// module id = 0\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/Entity.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("/* harmony export (immutable) */ __webpack_exports__[\"b\"] = loadImage;\n/* harmony export (immutable) */ __webpack_exports__[\"c\"] = loadJSON;\nfunction loadImage(url) {\r\n    return new Promise(resolve => {\r\n        const image = new Image();\r\n        image.addEventListener('load', () => {\r\n            resolve(image)\r\n        });\r\n\r\n        image.src = url\r\n    })\r\n}\r\n\r\nconst IS_DEV = location.host.indexOf('github.io') < 0\r\n\r\nconst PUBLIC_PATH = IS_DEV ? '' : 'https://juniortour.github.io/es6-mario/public/dist'\n/* harmony export (immutable) */ __webpack_exports__[\"a\"] = PUBLIC_PATH;\n\r\n\r\nfunction loadJSON(url) {\r\n    return fetch(PUBLIC_PATH + url)\r\n        .then(r => r.json());\r\n}\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/loader.js\n// module id = 1\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/loader.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('\r\nclass Matrix {\r\n    constructor() {\r\n        this.grid = []\r\n    }\r\n\r\n    forEach(callback) {\r\n        this.grid.forEach((column,x) => {\r\n            column.forEach((val,y) => {\r\n                callback(val,x,y)\r\n            })\r\n        })\r\n    }\r\n\r\n    get(x,y) {\r\n        const col = this.grid[x]\r\n\r\n        if (col) {\r\n            return col[y]\r\n        }\r\n        return undefined\r\n    }\r\n\r\n    set (x,y,value) {\r\n        if (!this.grid[x]) {\r\n            this.grid[x] = []\r\n        }\r\n\r\n        this.grid[x][y] = value\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = Matrix;\n\r\n\r\nclass Vec2 {\r\n    constructor(x, y) {\r\n        this.set(x, y)\r\n    }\r\n\r\n    set(x, y) {\r\n        this.x = x\r\n        this.y = y\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["b"] = Vec2;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/math.js\n// module id = 2\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/math.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony export (immutable) */ __webpack_exports__["a"] = loadSpriteSheet;\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__SpriteSheet__ = __webpack_require__(9);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__anim__ = __webpack_require__(30);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2__loader__ = __webpack_require__(1);\n\r\n\r\n\r\n\r\nfunction loadSpriteSheet(name) {\r\n    return Object(__WEBPACK_IMPORTED_MODULE_2__loader__["c" /* loadJSON */])(`/assets/sprites/${name}.json`)\r\n        .then(sheetSpec => Promise.all([\r\n            sheetSpec,\r\n            Object(__WEBPACK_IMPORTED_MODULE_2__loader__["b" /* loadImage */])(sheetSpec.imageURL)\r\n        ]))\r\n        .then(([sheetSpec, image]) => {\r\n            const sprites = new __WEBPACK_IMPORTED_MODULE_0__SpriteSheet__["a" /* default */](\r\n                image,\r\n                sheetSpec.tileW,\r\n                sheetSpec.tileH);\r\n\r\n            if (sheetSpec.tiles) {\r\n                sheetSpec.tiles.forEach(tileSpec => {\r\n                    sprites.defineTile(\r\n                        tileSpec.name, ...tileSpec.index);\r\n                })\r\n            }\r\n\r\n            if (sheetSpec.frames) {\r\n                sheetSpec.frames.forEach(frameSpec => {\r\n                    sprites.define(frameSpec.name, ...frameSpec.rect);\r\n                })\r\n            }\r\n\r\n            if (sheetSpec.animations) {\r\n                sheetSpec.animations.forEach(animSpec => {\r\n                    const animation = Object(__WEBPACK_IMPORTED_MODULE_1__anim__["a" /* createAnim */])(animSpec.frames, animSpec.frameLen);\r\n\r\n                    sprites.defineAnim(animSpec.name, animation);\r\n                })\r\n            }\r\n\r\n            return sprites;\r\n        });\r\n}\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/loaders/sprite.js\n// module id = 3\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/loaders/sprite.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__Entity_js__ = __webpack_require__(0);\n\r\n\r\nclass Killable extends __WEBPACK_IMPORTED_MODULE_0__Entity_js__["b" /* Trait */] {\r\n    constructor() {\r\n        super(\'killable\');\r\n        this.dead = false;\r\n        this.deadTime = 0;\r\n        this.removeAfter = 1;\r\n    }\r\n\r\n    kill() {\r\n        this.queue(() => this.dead = true);\r\n    }\r\n\r\n    revive() {\r\n        this.dead = false;\r\n        this.deadTime = 0;\r\n    }\r\n\r\n    update(entity, { deltaTime }, level) {\r\n        if (this.dead) {\r\n            this.deadTime += deltaTime;\r\n            if (this.deadTime > this.removeAfter) {\r\n                this.queue(() => {\r\n                    level.entities.delete(entity);\r\n                })\r\n            }\r\n        }\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = Killable;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/traits/Killable.js\n// module id = 4\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/traits/Killable.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__Entity_js__ = __webpack_require__(0);\n\r\n\r\nclass Solid extends __WEBPACK_IMPORTED_MODULE_0__Entity_js__["b" /* Trait */] {\r\n    constructor() {\r\n        super(\'solid\');\r\n        this.obstructs =true;\r\n    }\r\n\r\n    obstruct(entity, sides, match) {\r\n        if (!this.obstructs) {\r\n            return;\r\n        }\r\n\r\n        if (sides === __WEBPACK_IMPORTED_MODULE_0__Entity_js__["a" /* Sides */].BOTTOM) {\r\n            entity.bounds.top = match.y1 - entity.size.y;\r\n            entity.vel.y = 0;\r\n        } else if (sides === __WEBPACK_IMPORTED_MODULE_0__Entity_js__["a" /* Sides */].TOP) {\r\n            entity.bounds.top = match.y2;\r\n            entity.vel.y = 0;\r\n        } else if (sides === __WEBPACK_IMPORTED_MODULE_0__Entity_js__["a" /* Sides */].LEFT) {\r\n            entity.bounds.left = match.x1 - entity.size.x;\r\n            entity.vel.x = 0;\r\n        } else if (sides === __WEBPACK_IMPORTED_MODULE_0__Entity_js__["a" /* Sides */].RIGHT) {\r\n            entity.bounds.left = match.x2;\r\n            entity.vel.x = 0;\r\n        }\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = Solid;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/traits/Solid.js\n// module id = 5\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/traits/Solid.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__Entity_js__ = __webpack_require__(0);\n\r\n\r\nclass Physics extends __WEBPACK_IMPORTED_MODULE_0__Entity_js__["b" /* Trait */] {\r\n    constructor() {\r\n        super(\'physics\');\r\n    }\r\n\r\n    update(entity, { deltaTime }, level) {\r\n        entity.pos.x += entity.vel.x * deltaTime;\r\n        level.tileCollider.checkX(entity);\r\n\r\n        entity.pos.y += entity.vel.y * deltaTime;\r\n        level.tileCollider.checkY(entity);\r\n\r\n        entity.vel.y += level.gravity * deltaTime;\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = Physics;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/traits/Physics.js\n// module id = 6\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/traits/Physics.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('class TileResolver {\r\n    constructor(matrix, tileSize = 16) {\r\n        this.matrix = matrix;\r\n        this.tileSize = tileSize;\r\n    }\r\n\r\n    toIndex(pos) {\r\n        return Math.floor(pos / this.tileSize);\r\n    }\r\n\r\n    toIndexRange(pos1, pos2) {\r\n        const pMax = Math.ceil(pos2 / this.tileSize) * this.tileSize;\r\n        let range = [];\r\n        let pos = pos1;\r\n        do {\r\n            range.push(this.toIndex(pos));\r\n            pos += this.tileSize;\r\n        } while (pos < pMax);\r\n\r\n        return range;\r\n    }\r\n\r\n    getByIndex(indexX, indexY) {\r\n        const tile = this.matrix.get(indexX, indexY);\r\n        const x1 = indexX * this.tileSize;\r\n        const x2 = x1 + this.tileSize;\r\n        const y1 = indexY * this.tileSize;\r\n        const y2 = y1 + this.tileSize;\r\n        if (tile) {\r\n            return {\r\n                tile,\r\n                x1,\r\n                x2,\r\n                y1,\r\n                y2\r\n            };\r\n        }\r\n    }\r\n\r\n    searchByPosition(posX, posY) {\r\n        return this.getByIndex(\r\n            this.toIndex(posX),\r\n            this.toIndex(posY),\r\n        );\r\n    }\r\n\r\n    searchByRange(x1,x2,y1,y2) {\r\n        let matches = [];\r\n        this.toIndexRange(x1,x2).forEach(indexX => {\r\n            this.toIndexRange(y1,y2).forEach(indexY => {\r\n                let match = this.getByIndex(indexX, indexY);\r\n                if (match) {\r\n                    matches.push(match);\r\n                }\r\n            })\r\n        });\r\n\r\n        return matches;\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = TileResolver;\n\r\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/TileResolver.js\n// module id = 7\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/TileResolver.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('class AudioBoard {\r\n    constructor () {\r\n        // this.context = context\r\n        // not hardcore audioContext, but send it as a param below,\r\n        // so than we can change the context easily.\r\n        this.buffers = new Map()\r\n    }\r\n\r\n    addAudio(name, buffer) {\r\n        this.buffers.set(name, buffer)\r\n    }\r\n\r\n    playAudio(name, audioContext) {\r\n        const source = audioContext.createBufferSource()\r\n\r\n        // TODO Global Volume Setting\r\n        // const gainNode = audioContext.createGain();\r\n        // gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);\r\n        // source.connect(gainNode)\r\n        // gainNode.connect(audioContext.destination);\r\n\r\n        source.connect(audioContext.destination)\r\n        source.buffer = this.buffers.get(name)\r\n        source.start(0)\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = AudioBoard;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/AudioBoard.js\n// module id = 8\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/AudioBoard.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("class SpriteSheet {\r\n    constructor(image, width, height) {\r\n        this.image = image;\r\n        this.width = width;\r\n        this.height = height;\r\n        this.tiles = new Map();\r\n        this.animations = new Map();\r\n    }\r\n\r\n    defineAnim(name, animation) {\r\n        this.animations.set(name, animation);\r\n    }\r\n\r\n    define(name, x, y, width, height) {\r\n        // define a sprite in the image with name\r\n        // 明确定义一块位于sprite sheet中x,y位置width, height的sprite\r\n        const buffers = [false, true].map(flip => {\r\n            const buffer = document.createElement('canvas');\r\n            buffer.width = width;\r\n            buffer.height = height;\r\n\r\n            const context = buffer.getContext('2d');\r\n\r\n            if (flip) {\r\n                // Mirror the canvas\r\n                context.scale(-1, 1);\r\n                context.translate(-width, 0);\r\n            }\r\n\r\n            context.drawImage(\r\n                    this.image,\r\n                    x,\r\n                    y,\r\n                    width,\r\n                    height,\r\n                    0,\r\n                    0,\r\n                    width,\r\n                    height);\r\n\r\n            return buffer;\r\n        });\r\n\r\n        this.tiles.set(name, buffers);\r\n    }\r\n\r\n    defineTile(name, x, y) {\r\n        this.define(name, x * this.width, y * this.height, this.width, this.height);\r\n    }\r\n\r\n    draw(name, context, x, y, flip = false) {\r\n        const buffer = this.tiles.get(name)[flip ? 1 : 0];\r\n        context.drawImage(buffer, x, y);\r\n    }\r\n\r\n    drawTile(name, context, x, y) {\r\n        this.draw(name, context, x*this.width, y*this.height);\r\n    }\r\n\r\n    drawAnim(name, context, x, y, distance) {\r\n        const anim = this.animations.get(name);\r\n        this.drawTile(anim(distance), context, x, y);\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__[\"a\"] = SpriteSheet;\n\r\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/SpriteSheet.js\n// module id = 9\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/SpriteSheet.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__Entity_js__ = __webpack_require__(0);\n\r\n\r\nclass PendulumMove extends __WEBPACK_IMPORTED_MODULE_0__Entity_js__["b" /* Trait */] {\r\n    constructor() {\r\n        super(\'pendulumMove\');\r\n        this.enable = true;\r\n        this.speed =  -30;\r\n    }\r\n\r\n    obstruct(koopa, sides) {\r\n        if (sides === __WEBPACK_IMPORTED_MODULE_0__Entity_js__["a" /* Sides */].LEFT || sides === __WEBPACK_IMPORTED_MODULE_0__Entity_js__["a" /* Sides */].RIGHT) {\r\n            this.speed = -this.speed;\r\n        }\r\n    }\r\n\r\n    update(entity, { deltaTime }) {\r\n        entity.lifeTime += deltaTime;\r\n        if (this.enable) {\r\n            entity.vel.x = this.speed;\r\n        }\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = PendulumMove;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/traits/PendulumMove.js\n// module id = 10\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/traits/PendulumMove.js?')},function(module,exports,__webpack_require__){eval("__webpack_require__(12);\nmodule.exports = __webpack_require__(13);\n\n\n//////////////////\n// WEBPACK FOOTER\n// multi whatwg-fetch ./public/js/main.js\n// module id = 11\n// module chunks = 0\n\n//# sourceURL=webpack:///multi_whatwg-fetch_./public/js/main.js?")},function(module,exports){eval("(function(self) {\n  'use strict';\n\n  if (self.fetch) {\n    return\n  }\n\n  var support = {\n    searchParams: 'URLSearchParams' in self,\n    iterable: 'Symbol' in self && 'iterator' in Symbol,\n    blob: 'FileReader' in self && 'Blob' in self && (function() {\n      try {\n        new Blob()\n        return true\n      } catch(e) {\n        return false\n      }\n    })(),\n    formData: 'FormData' in self,\n    arrayBuffer: 'ArrayBuffer' in self\n  }\n\n  if (support.arrayBuffer) {\n    var viewClasses = [\n      '[object Int8Array]',\n      '[object Uint8Array]',\n      '[object Uint8ClampedArray]',\n      '[object Int16Array]',\n      '[object Uint16Array]',\n      '[object Int32Array]',\n      '[object Uint32Array]',\n      '[object Float32Array]',\n      '[object Float64Array]'\n    ]\n\n    var isDataView = function(obj) {\n      return obj && DataView.prototype.isPrototypeOf(obj)\n    }\n\n    var isArrayBufferView = ArrayBuffer.isView || function(obj) {\n      return obj && viewClasses.indexOf(Object.prototype.toString.call(obj)) > -1\n    }\n  }\n\n  function normalizeName(name) {\n    if (typeof name !== 'string') {\n      name = String(name)\n    }\n    if (/[^a-z0-9\\-#$%&'*+.\\^_`|~]/i.test(name)) {\n      throw new TypeError('Invalid character in header field name')\n    }\n    return name.toLowerCase()\n  }\n\n  function normalizeValue(value) {\n    if (typeof value !== 'string') {\n      value = String(value)\n    }\n    return value\n  }\n\n  // Build a destructive iterator for the value list\n  function iteratorFor(items) {\n    var iterator = {\n      next: function() {\n        var value = items.shift()\n        return {done: value === undefined, value: value}\n      }\n    }\n\n    if (support.iterable) {\n      iterator[Symbol.iterator] = function() {\n        return iterator\n      }\n    }\n\n    return iterator\n  }\n\n  function Headers(headers) {\n    this.map = {}\n\n    if (headers instanceof Headers) {\n      headers.forEach(function(value, name) {\n        this.append(name, value)\n      }, this)\n    } else if (Array.isArray(headers)) {\n      headers.forEach(function(header) {\n        this.append(header[0], header[1])\n      }, this)\n    } else if (headers) {\n      Object.getOwnPropertyNames(headers).forEach(function(name) {\n        this.append(name, headers[name])\n      }, this)\n    }\n  }\n\n  Headers.prototype.append = function(name, value) {\n    name = normalizeName(name)\n    value = normalizeValue(value)\n    var oldValue = this.map[name]\n    this.map[name] = oldValue ? oldValue+','+value : value\n  }\n\n  Headers.prototype['delete'] = function(name) {\n    delete this.map[normalizeName(name)]\n  }\n\n  Headers.prototype.get = function(name) {\n    name = normalizeName(name)\n    return this.has(name) ? this.map[name] : null\n  }\n\n  Headers.prototype.has = function(name) {\n    return this.map.hasOwnProperty(normalizeName(name))\n  }\n\n  Headers.prototype.set = function(name, value) {\n    this.map[normalizeName(name)] = normalizeValue(value)\n  }\n\n  Headers.prototype.forEach = function(callback, thisArg) {\n    for (var name in this.map) {\n      if (this.map.hasOwnProperty(name)) {\n        callback.call(thisArg, this.map[name], name, this)\n      }\n    }\n  }\n\n  Headers.prototype.keys = function() {\n    var items = []\n    this.forEach(function(value, name) { items.push(name) })\n    return iteratorFor(items)\n  }\n\n  Headers.prototype.values = function() {\n    var items = []\n    this.forEach(function(value) { items.push(value) })\n    return iteratorFor(items)\n  }\n\n  Headers.prototype.entries = function() {\n    var items = []\n    this.forEach(function(value, name) { items.push([name, value]) })\n    return iteratorFor(items)\n  }\n\n  if (support.iterable) {\n    Headers.prototype[Symbol.iterator] = Headers.prototype.entries\n  }\n\n  function consumed(body) {\n    if (body.bodyUsed) {\n      return Promise.reject(new TypeError('Already read'))\n    }\n    body.bodyUsed = true\n  }\n\n  function fileReaderReady(reader) {\n    return new Promise(function(resolve, reject) {\n      reader.onload = function() {\n        resolve(reader.result)\n      }\n      reader.onerror = function() {\n        reject(reader.error)\n      }\n    })\n  }\n\n  function readBlobAsArrayBuffer(blob) {\n    var reader = new FileReader()\n    var promise = fileReaderReady(reader)\n    reader.readAsArrayBuffer(blob)\n    return promise\n  }\n\n  function readBlobAsText(blob) {\n    var reader = new FileReader()\n    var promise = fileReaderReady(reader)\n    reader.readAsText(blob)\n    return promise\n  }\n\n  function readArrayBufferAsText(buf) {\n    var view = new Uint8Array(buf)\n    var chars = new Array(view.length)\n\n    for (var i = 0; i < view.length; i++) {\n      chars[i] = String.fromCharCode(view[i])\n    }\n    return chars.join('')\n  }\n\n  function bufferClone(buf) {\n    if (buf.slice) {\n      return buf.slice(0)\n    } else {\n      var view = new Uint8Array(buf.byteLength)\n      view.set(new Uint8Array(buf))\n      return view.buffer\n    }\n  }\n\n  function Body() {\n    this.bodyUsed = false\n\n    this._initBody = function(body) {\n      this._bodyInit = body\n      if (!body) {\n        this._bodyText = ''\n      } else if (typeof body === 'string') {\n        this._bodyText = body\n      } else if (support.blob && Blob.prototype.isPrototypeOf(body)) {\n        this._bodyBlob = body\n      } else if (support.formData && FormData.prototype.isPrototypeOf(body)) {\n        this._bodyFormData = body\n      } else if (support.searchParams && URLSearchParams.prototype.isPrototypeOf(body)) {\n        this._bodyText = body.toString()\n      } else if (support.arrayBuffer && support.blob && isDataView(body)) {\n        this._bodyArrayBuffer = bufferClone(body.buffer)\n        // IE 10-11 can't handle a DataView body.\n        this._bodyInit = new Blob([this._bodyArrayBuffer])\n      } else if (support.arrayBuffer && (ArrayBuffer.prototype.isPrototypeOf(body) || isArrayBufferView(body))) {\n        this._bodyArrayBuffer = bufferClone(body)\n      } else {\n        throw new Error('unsupported BodyInit type')\n      }\n\n      if (!this.headers.get('content-type')) {\n        if (typeof body === 'string') {\n          this.headers.set('content-type', 'text/plain;charset=UTF-8')\n        } else if (this._bodyBlob && this._bodyBlob.type) {\n          this.headers.set('content-type', this._bodyBlob.type)\n        } else if (support.searchParams && URLSearchParams.prototype.isPrototypeOf(body)) {\n          this.headers.set('content-type', 'application/x-www-form-urlencoded;charset=UTF-8')\n        }\n      }\n    }\n\n    if (support.blob) {\n      this.blob = function() {\n        var rejected = consumed(this)\n        if (rejected) {\n          return rejected\n        }\n\n        if (this._bodyBlob) {\n          return Promise.resolve(this._bodyBlob)\n        } else if (this._bodyArrayBuffer) {\n          return Promise.resolve(new Blob([this._bodyArrayBuffer]))\n        } else if (this._bodyFormData) {\n          throw new Error('could not read FormData body as blob')\n        } else {\n          return Promise.resolve(new Blob([this._bodyText]))\n        }\n      }\n\n      this.arrayBuffer = function() {\n        if (this._bodyArrayBuffer) {\n          return consumed(this) || Promise.resolve(this._bodyArrayBuffer)\n        } else {\n          return this.blob().then(readBlobAsArrayBuffer)\n        }\n      }\n    }\n\n    this.text = function() {\n      var rejected = consumed(this)\n      if (rejected) {\n        return rejected\n      }\n\n      if (this._bodyBlob) {\n        return readBlobAsText(this._bodyBlob)\n      } else if (this._bodyArrayBuffer) {\n        return Promise.resolve(readArrayBufferAsText(this._bodyArrayBuffer))\n      } else if (this._bodyFormData) {\n        throw new Error('could not read FormData body as text')\n      } else {\n        return Promise.resolve(this._bodyText)\n      }\n    }\n\n    if (support.formData) {\n      this.formData = function() {\n        return this.text().then(decode)\n      }\n    }\n\n    this.json = function() {\n      return this.text().then(JSON.parse)\n    }\n\n    return this\n  }\n\n  // HTTP methods whose capitalization should be normalized\n  var methods = ['DELETE', 'GET', 'HEAD', 'OPTIONS', 'POST', 'PUT']\n\n  function normalizeMethod(method) {\n    var upcased = method.toUpperCase()\n    return (methods.indexOf(upcased) > -1) ? upcased : method\n  }\n\n  function Request(input, options) {\n    options = options || {}\n    var body = options.body\n\n    if (input instanceof Request) {\n      if (input.bodyUsed) {\n        throw new TypeError('Already read')\n      }\n      this.url = input.url\n      this.credentials = input.credentials\n      if (!options.headers) {\n        this.headers = new Headers(input.headers)\n      }\n      this.method = input.method\n      this.mode = input.mode\n      if (!body && input._bodyInit != null) {\n        body = input._bodyInit\n        input.bodyUsed = true\n      }\n    } else {\n      this.url = String(input)\n    }\n\n    this.credentials = options.credentials || this.credentials || 'omit'\n    if (options.headers || !this.headers) {\n      this.headers = new Headers(options.headers)\n    }\n    this.method = normalizeMethod(options.method || this.method || 'GET')\n    this.mode = options.mode || this.mode || null\n    this.referrer = null\n\n    if ((this.method === 'GET' || this.method === 'HEAD') && body) {\n      throw new TypeError('Body not allowed for GET or HEAD requests')\n    }\n    this._initBody(body)\n  }\n\n  Request.prototype.clone = function() {\n    return new Request(this, { body: this._bodyInit })\n  }\n\n  function decode(body) {\n    var form = new FormData()\n    body.trim().split('&').forEach(function(bytes) {\n      if (bytes) {\n        var split = bytes.split('=')\n        var name = split.shift().replace(/\\+/g, ' ')\n        var value = split.join('=').replace(/\\+/g, ' ')\n        form.append(decodeURIComponent(name), decodeURIComponent(value))\n      }\n    })\n    return form\n  }\n\n  function parseHeaders(rawHeaders) {\n    var headers = new Headers()\n    // Replace instances of \\r\\n and \\n followed by at least one space or horizontal tab with a space\n    // https://tools.ietf.org/html/rfc7230#section-3.2\n    var preProcessedHeaders = rawHeaders.replace(/\\r?\\n[\\t ]+/g, ' ')\n    preProcessedHeaders.split(/\\r?\\n/).forEach(function(line) {\n      var parts = line.split(':')\n      var key = parts.shift().trim()\n      if (key) {\n        var value = parts.join(':').trim()\n        headers.append(key, value)\n      }\n    })\n    return headers\n  }\n\n  Body.call(Request.prototype)\n\n  function Response(bodyInit, options) {\n    if (!options) {\n      options = {}\n    }\n\n    this.type = 'default'\n    this.status = options.status === undefined ? 200 : options.status\n    this.ok = this.status >= 200 && this.status < 300\n    this.statusText = 'statusText' in options ? options.statusText : 'OK'\n    this.headers = new Headers(options.headers)\n    this.url = options.url || ''\n    this._initBody(bodyInit)\n  }\n\n  Body.call(Response.prototype)\n\n  Response.prototype.clone = function() {\n    return new Response(this._bodyInit, {\n      status: this.status,\n      statusText: this.statusText,\n      headers: new Headers(this.headers),\n      url: this.url\n    })\n  }\n\n  Response.error = function() {\n    var response = new Response(null, {status: 0, statusText: ''})\n    response.type = 'error'\n    return response\n  }\n\n  var redirectStatuses = [301, 302, 303, 307, 308]\n\n  Response.redirect = function(url, status) {\n    if (redirectStatuses.indexOf(status) === -1) {\n      throw new RangeError('Invalid status code')\n    }\n\n    return new Response(null, {status: status, headers: {location: url}})\n  }\n\n  self.Headers = Headers\n  self.Request = Request\n  self.Response = Response\n\n  self.fetch = function(input, init) {\n    return new Promise(function(resolve, reject) {\n      var request = new Request(input, init)\n      var xhr = new XMLHttpRequest()\n\n      xhr.onload = function() {\n        var options = {\n          status: xhr.status,\n          statusText: xhr.statusText,\n          headers: parseHeaders(xhr.getAllResponseHeaders() || '')\n        }\n        options.url = 'responseURL' in xhr ? xhr.responseURL : options.headers.get('X-Request-URL')\n        var body = 'response' in xhr ? xhr.response : xhr.responseText\n        resolve(new Response(body, options))\n      }\n\n      xhr.onerror = function() {\n        reject(new TypeError('Network request failed'))\n      }\n\n      xhr.ontimeout = function() {\n        reject(new TypeError('Network request failed'))\n      }\n\n      xhr.open(request.method, request.url, true)\n\n      if (request.credentials === 'include') {\n        xhr.withCredentials = true\n      } else if (request.credentials === 'omit') {\n        xhr.withCredentials = false\n      }\n\n      if ('responseType' in xhr && support.blob) {\n        xhr.responseType = 'blob'\n      }\n\n      request.headers.forEach(function(value, name) {\n        xhr.setRequestHeader(name, value)\n      })\n\n      xhr.send(typeof request._bodyInit === 'undefined' ? null : request._bodyInit)\n    })\n  }\n  self.fetch.polyfill = true\n})(typeof self !== 'undefined' ? self : this);\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./node_modules/whatwg-fetch/fetch.js\n// module id = 12\n// module chunks = 0\n\n//# sourceURL=webpack:///./node_modules/whatwg-fetch/fetch.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("Object.defineProperty(__webpack_exports__, \"__esModule\", { value: true });\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__css_main_css__ = __webpack_require__(14);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__css_main_css___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_0__css_main_css__);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__css_controller_css__ = __webpack_require__(15);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__css_controller_css___default = __webpack_require__.n(__WEBPACK_IMPORTED_MODULE_1__css_controller_css__);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2__Timer_js__ = __webpack_require__(16);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_3__Camera_js__ = __webpack_require__(17);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_4__loaders_level_js__ = __webpack_require__(18);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_5__loaders_font_js__ = __webpack_require__(31);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_6__entities_js__ = __webpack_require__(32);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_7__layers_dashboard_js__ = __webpack_require__(40);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_8__input_input_js__ = __webpack_require__(42);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_9__polyfills_getUserAgent_js__ = __webpack_require__(45);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_10__polyfills_autoPlayOniOS_js__ = __webpack_require__(46);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_11__player__ = __webpack_require__(47);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_12__loader__ = __webpack_require__(1);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_13__layers_wating__ = __webpack_require__(50);\n\r\n\r\n/*TODO: CSS import in Js, I don't like it.*/\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// import {createCollisionLayer} from './layers/collision.js'\r\n// import {createCameraLayer} from './layers/camera.js';\r\n// import {setupMouseControl} from './debug.js';\r\n\r\nlet curRunningGameTimer = null\r\nconst startControlDemo = (totalTime, mario) => {\r\n    if (totalTime < 5) {\r\n        if (totalTime >= 3) {\r\n            mario.go.dir = 1\r\n        }\r\n        if (totalTime >= 4.2 && totalTime < 4.5) {\r\n            mario.jump.start()\r\n        }\r\n    } else {\r\n        mario.go.dir = totalTime.toFixed() % 2 ? 1: -1\r\n    }\r\n}\r\n\r\nasync function main(canvas, isWaitingScreen) {\r\n    const context = canvas.getContext('2d');\r\n\r\n    const audioContext = new window.AudioContext()\r\n    const [entityFactory, font] = await Promise.all([\r\n        Object(__WEBPACK_IMPORTED_MODULE_6__entities_js__[\"a\" /* loadEntities */])(audioContext),\r\n        Object(__WEBPACK_IMPORTED_MODULE_5__loaders_font_js__[\"a\" /* loadFont */])()\r\n    ]);\r\n    const loadLevel = await Object(__WEBPACK_IMPORTED_MODULE_4__loaders_level_js__[\"a\" /* createLevelLoader */])(entityFactory);\r\n    const level = await loadLevel('1-1');\r\n\r\n    const camera = new __WEBPACK_IMPORTED_MODULE_3__Camera_js__[\"a\" /* default */]();\r\n\r\n    const mario = Object(__WEBPACK_IMPORTED_MODULE_11__player__[\"a\" /* createPlayer */])(entityFactory.mario());\r\n    mario.pos.set(4*16, 12*16);\r\n    level.entities.add(mario);\r\n\r\n    const playerEnv = Object(__WEBPACK_IMPORTED_MODULE_11__player__[\"b\" /* createPlayerEnv */])(mario);\r\n    level.entities.add(playerEnv);\r\n\r\n    level.comp.layers.push(Object(__WEBPACK_IMPORTED_MODULE_7__layers_dashboard_js__[\"a\" /* createDashboardLayer */])(font, playerEnv, isWaitingScreen));\r\n\r\n    if (isWaitingScreen) {\r\n        const logoImg = await Object(__WEBPACK_IMPORTED_MODULE_12__loader__[\"b\" /* loadImage */])('/assets/img/logo.png')\r\n        level.comp.layers.push(Object(__WEBPACK_IMPORTED_MODULE_13__layers_wating__[\"a\" /* createWaitingLayer */])(font, logoImg));\r\n    }\r\n\r\n    /*Debug Tools : */\r\n    // level.comp.layers.push(createCollisionLayer(level));\r\n    // level.comp.layers.push(createCameraLayer(camera));\r\n    // setupMouseControl(canvas, mario, camera);\r\n\r\n    // TODO Optimize Hack for Compatibility\r\n    let fps = 1/60;\r\n\r\n    const uaInfo = Object(__WEBPACK_IMPORTED_MODULE_9__polyfills_getUserAgent_js__[\"a\" /* getUserAgent */])();\r\n    if (uaInfo.platform === 'Android' ||\r\n        uaInfo.platform === 'iOS') {\r\n        if (!isWaitingScreen) {\r\n            Object(__WEBPACK_IMPORTED_MODULE_8__input_input_js__[\"b\" /* setupTouchPad */])(mario);\r\n        }\r\n\r\n        // For low-end device, decrease fps for performance.\r\n        if ((uaInfo.platform === 'iOS' && uaInfo.ver < 10)\r\n              || (uaInfo.platform === 'Android' && uaInfo.ver < 7)) {\r\n            fps = 1/20;\r\n        }\r\n\r\n        if (uaInfo.platform === 'iOS') {\r\n            Object(__WEBPACK_IMPORTED_MODULE_10__polyfills_autoPlayOniOS_js__[\"a\" /* autoPlayOniOS */])();\r\n        }\r\n    } else {\r\n        // TODO: listen to window.onresize???\r\n        if (!isWaitingScreen) {\r\n            const input = Object(__WEBPACK_IMPORTED_MODULE_8__input_input_js__[\"a\" /* setupKeyboard */])(mario);\r\n            input.listenTo(window);\r\n        }\r\n    }\r\n\r\n    const gameContext = {\r\n        accumulatedTime: 0,\r\n        deltaTime: undefined,\r\n        audioContext\r\n        // audioBoard\r\n    }\r\n\r\n    const timer = new __WEBPACK_IMPORTED_MODULE_2__Timer_js__[\"a\" /* default */](fps);\r\n\r\n    timer.update = function update(deltaTime) {\r\n        gameContext.accumulatedTime += deltaTime\r\n        gameContext.deltaTime = deltaTime\r\n        level.update(gameContext);\r\n\r\n        camera.pos.x = Math.max(0, mario.pos.x - 100);\r\n\r\n        level.comp.draw(context, camera);\r\n\r\n        if (isWaitingScreen) {\r\n            startControlDemo(gameContext.accumulatedTime, mario)\r\n        }\r\n    };\r\n\r\n    timer.start();\r\n    if (!isWaitingScreen) {\r\n        level.music.player.playTrack('main')\r\n    }\r\n\r\n    curRunningGameTimer = timer\r\n}\r\n\r\n\r\nconst canvas = document.getElementById('screen');\r\n\r\n// TODO Destroy Canvas Ele is Not a good solution, consider runtime re-render.\r\nconst startWaitingScreen = () => {\r\n    main(canvas, true)\r\n}\r\nstartWaitingScreen()\r\n\r\nconst start = () => {\r\n    window.removeEventListener('click', start)\r\n\r\n    if (curRunningGameTimer && curRunningGameTimer.stop) {\r\n        curRunningGameTimer.stop()\r\n    }\r\n\r\n    document.body.removeChild(canvas)\r\n    const newCanvas = document.createElement('canvas');\r\n    newCanvas.id = 'screen';\r\n    newCanvas.width='256'\r\n    newCanvas.height='240'\r\n    document.body.appendChild(newCanvas);\r\n\r\n    // Auto Play audio will not take effect unless after user interact.\r\n    main(newCanvas)\r\n}\r\nwindow.addEventListener('click', start)\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/main.js\n// module id = 13\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/main.js?")},function(module,exports){eval("// removed by extract-text-webpack-plugin\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/css/main.css\n// module id = 14\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/css/main.css?")},function(module,exports){eval("// removed by extract-text-webpack-plugin\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/css/controller.css\n// module id = 15\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/css/controller.css?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('class Timer {\r\n    constructor(deltaTime = 1/60) {\r\n        this.animationFrameID = null\r\n\r\n        let accumulatedTime = 0;\r\n        let lastTime = 0;\r\n\r\n        this.updateProxy =  (time) => {\r\n            accumulatedTime += (time - lastTime) / 1000;\r\n\r\n            if (accumulatedTime > 1) {\r\n                /* A hack to Solve the time accumulate\r\n                * when it is running background.\r\n                * So that our computer wont be slow down by this,\r\n                * after long time of running this in background.*/\r\n                accumulatedTime = 1;\r\n            }\r\n\r\n            while (accumulatedTime > deltaTime) {\r\n                this.update(deltaTime);\r\n\r\n                accumulatedTime -= deltaTime;\r\n            }\r\n\r\n            lastTime = time;\r\n\r\n            this.enqueue();\r\n        }\r\n    }\r\n\r\n    enqueue() {\r\n        this.animationFrameID = requestAnimationFrame(this.updateProxy);\r\n    }\r\n\r\n    start() {\r\n        this.enqueue();\r\n    }\r\n\r\n    stop() {\r\n        if (this.animationFrameID) {\r\n            window.cancelAnimationFrame(this.animationFrameID)\r\n        }\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = Timer;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/Timer.js\n// module id = 16\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/Timer.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__math_js__ = __webpack_require__(2);\n\r\n\r\nclass Camera {\r\n    constructor() {\r\n        this.pos = new __WEBPACK_IMPORTED_MODULE_0__math_js__["b" /* Vec2 */](0,0);\r\n        this.size = new __WEBPACK_IMPORTED_MODULE_0__math_js__["b" /* Vec2 */](256,240);\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = Camera;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/Camera.js\n// module id = 17\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/Camera.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony export (immutable) */ __webpack_exports__["a"] = createLevelLoader;\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__math_js__ = __webpack_require__(2);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__Level_js__ = __webpack_require__(19);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2__loader_js__ = __webpack_require__(1);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_3__layers_sprites_js__ = __webpack_require__(26);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_4__layers_background_js__ = __webpack_require__(27);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_5__music__ = __webpack_require__(28);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_6__sprite__ = __webpack_require__(3);\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nfunction setupLevel(levelSpec, level) {\r\n    const mergedCollisionGrid = levelSpec.layers.reduce((mergedTiles, layerSpec) => {\r\n        return mergedTiles.concat(layerSpec.tiles);\r\n    }, []);\r\n\r\n    const collisionGrid = createCollisionGrid(mergedCollisionGrid, levelSpec.patterns);\r\n    level.setCollisionGrid(collisionGrid);\r\n}\r\n\r\nfunction setupBackground(levelSpec, level, backgroundSprites) {\r\n    levelSpec.layers.forEach(layer => {\r\n        const backgroundGrid = createBackgroundGrid(layer.tiles, levelSpec.patterns);\r\n        const backgroundLayer = Object(__WEBPACK_IMPORTED_MODULE_4__layers_background_js__["a" /* createBackgroundLayer */])(level, backgroundGrid, backgroundSprites);\r\n        level.comp.layers.push(backgroundLayer);\r\n    });\r\n}\r\n\r\nfunction setupEntities(levelSpec, level, entityFactory) {\r\n    const tileSize = 16;\r\n    levelSpec.entities.forEach(({name, positions}) => {\r\n        positions.forEach(([x, y]) => {\r\n            const createEntity = entityFactory[name];\r\n            const entity = createEntity();\r\n            entity.pos.set(x*tileSize, y*tileSize);\r\n            level.entities.add(entity);\r\n        })\r\n    });\r\n\r\n    const spriteLayer = Object(__WEBPACK_IMPORTED_MODULE_3__layers_sprites_js__["a" /* createSpriteLayer */])(level.entities);\r\n    level.comp.layers.push(spriteLayer);\r\n}\r\n\r\nfunction createLevelLoader(entityFactory) {\r\n    return function loadLevel(name) {\r\n        return Object(__WEBPACK_IMPORTED_MODULE_2__loader_js__["c" /* loadJSON */])(`/assets/levels/${name}.json`)\r\n            .then(levelSpec => Promise.all([\r\n                levelSpec,\r\n                Object(__WEBPACK_IMPORTED_MODULE_6__sprite__["a" /* loadSpriteSheet */])(levelSpec.spriteSheet),\r\n                Object(__WEBPACK_IMPORTED_MODULE_5__music__["a" /* loadMusicSheet */])(levelSpec.musicSheet)\r\n            ]))\r\n            .then(([levelSpec, backgroundSprites, musciPlayer]) => {\r\n                console.log(musciPlayer)\r\n                const level = new __WEBPACK_IMPORTED_MODULE_1__Level_js__["a" /* default */]();\r\n                level.music.setPlayer(musciPlayer)\r\n\r\n                setupLevel(levelSpec, level);\r\n                setupBackground(levelSpec, level, backgroundSprites);\r\n                setupEntities(levelSpec, level, entityFactory);\r\n\r\n                return level;\r\n            })\r\n    }\r\n}\r\n\r\nfunction createCollisionGrid(tiles, patterns) {\r\n    const grid = new __WEBPACK_IMPORTED_MODULE_0__math_js__["a" /* Matrix */]();\r\n\r\n    for (const {tile, x, y} of expandTiles(tiles, patterns)) {\r\n        grid.set(x, y, {type: tile.type})\r\n    }\r\n\r\n    return grid;\r\n}\r\n\r\nfunction createBackgroundGrid(tiles, patterns) {\r\n    const grid = new __WEBPACK_IMPORTED_MODULE_0__math_js__["a" /* Matrix */]();\r\n\r\n    for (const {tile, x, y} of expandTiles(tiles, patterns)) {\r\n        grid.set(x, y, {name: tile.name})\r\n    }\r\n\r\n    return grid;\r\n}\r\n\r\n// ES6 Generator Function\r\nfunction* expandSpan(xStart, xLen, yStart, yLen) {\r\n    // debugger\r\n    // const coords = [];\r\n    const xEnd = xStart + xLen;\r\n    const yEnd = yStart + yLen;\r\n    for (let x = xStart; x < xEnd; x++) {\r\n        for (let y = yStart; y < yEnd; y++) {\r\n            // coords.push({x, y});\r\n            yield {x, y};\r\n            // create a Iterator Object for the following for...of\r\n        }\r\n    }\r\n\r\n    // return coords;\r\n}\r\n\r\nfunction expandRange(range) {\r\n    if (range.length === 4) {\r\n        const [xStart, xLen, yStart, yLen] = range;\r\n        return expandSpan(xStart, xLen, yStart, yLen)\r\n    } else if (range.length === 3) {\r\n        const [xStart, xLen, yStart] = range;\r\n        return expandSpan(xStart, xLen, yStart, 1)\r\n    } else if (range.length === 2) {\r\n        const [xStart, yStart] = range;\r\n        return expandSpan(xStart, 1, yStart, 1)\r\n    }\r\n}\r\n\r\nfunction* expandRanges(ranges) {\r\n    for (const range of ranges) {\r\n        yield* expandRange(range);\r\n    }\r\n}\r\n\r\nfunction* expandTiles(tiles, patterns) {\r\n    // let expandedTiles = [];\r\n\r\n    function* walkTiles(tiles, offsetX, offsetY) {\r\n        for (const tile of tiles) {\r\n            for (const {x, y} of expandRanges(tile.ranges)) {\r\n                /* http://es6.ruanyifeng.com/?search=yield&x=0&y=0#docs/generator#for---of-%E5%BE%AA%E7%8E%AF\r\n                 Use for...of to iterate the Iterator Object generated by the yield of Generator Function.*/\r\n                const derivedX = x + offsetX;\r\n                const derivedY = y + offsetY;\r\n\r\n                // debugger\r\n                if (tile.pattern) {\r\n                    // console.log(patterns[tile.pattern]);\r\n                    const tiles = patterns[tile.pattern].tiles;\r\n                    // createTiles(level, tiles, patterns, derivedX, derivedY);\r\n                    /*TODO:Figure out th useage of yield**/\r\n                    yield* walkTiles(tiles, derivedX, derivedY);\r\n                } else {\r\n                    yield {\r\n                        tile,\r\n                        x: derivedX,\r\n                        y: derivedY\r\n                    };\r\n                    // expandedTiles.push({\r\n                    //     tile,\r\n                    //     x: derivedX,\r\n                    //     y: derivedY\r\n                    // });\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    yield* walkTiles(tiles, 0, 0);\r\n\r\n    // return expandedTiles;\r\n}\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/loaders/level.js\n// module id = 18\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/loaders/level.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__compositor_js__ = __webpack_require__(20);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__EntityCollider_js__ = __webpack_require__(21);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2__TileCollider_js__ = __webpack_require__(22);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_3__MusicController__ = __webpack_require__(25);\n\r\n\r\n\r\n\r\n\r\nclass Level {\r\n    constructor() {\r\n        this.gravity = 1500;\r\n        this.comp = new __WEBPACK_IMPORTED_MODULE_0__compositor_js__["a" /* default */]();\r\n        this.entities = new Set();\r\n        this.entityCollider = new __WEBPACK_IMPORTED_MODULE_1__EntityCollider_js__["a" /* default */](this.entities);\r\n        this.totalTime = 0;\r\n        this.music = new __WEBPACK_IMPORTED_MODULE_3__MusicController__["a" /* default */]()\r\n        this.tileCollider = null;\r\n    }\r\n\r\n    setCollisionGrid(matrix) {\r\n        this.tileCollider = new __WEBPACK_IMPORTED_MODULE_2__TileCollider_js__["a" /* default */](matrix);\r\n    }\r\n\r\n    update(gameContext) {\r\n        this.entities.forEach(entity => {\r\n            entity.update(gameContext, this);\r\n        });\r\n\r\n\r\n        this.entities.forEach(entity => {\r\n            entity.finalize();\r\n\r\n            this.entityCollider.check(entity);\r\n        });\r\n\r\n        this.totalTime += gameContext.deltaTime;\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = Level;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/Level.js\n// module id = 19\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/Level.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('class Compositor {\r\n    constructor() {\r\n        this.layers = [];\r\n    }\r\n\r\n    draw(context, camera) {\r\n        this.layers.forEach(layer => {\r\n            layer(context, camera);\r\n        })\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = Compositor;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/compositor.js\n// module id = 20\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/compositor.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('\r\n\r\nclass EntityCollider {\r\n    constructor(entities) {\r\n        this.entities = entities;\r\n    }\r\n\r\n    check(subject) {\r\n        this.entities.forEach(candidate => {\r\n            if (subject === candidate) {\r\n                return;\r\n            }\r\n\r\n            if (subject.bounds.overlaps(candidate.bounds)) {\r\n              subject.collides(candidate);\r\n              candidate.collides(subject);\r\n            }\r\n        })\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = EntityCollider;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/EntityCollider.js\n// module id = 21\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/EntityCollider.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__TileResolver_js__ = __webpack_require__(7);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__Entity_js__ = __webpack_require__(0);\n\r\n\r\n\r\nclass TileCollider {\r\n    constructor(tileMatrix) {\r\n        this.tile = new __WEBPACK_IMPORTED_MODULE_0__TileResolver_js__["a" /* default */](tileMatrix);\r\n    }\r\n\r\n    checkX(entity) {\r\n        let x;\r\n        if (entity.vel.x > 0) {\r\n            // mario is going toward RIGHT\r\n            // so we just need to check the RIGHT side of entity\r\n            x = entity.bounds.right;\r\n        } else if (entity.vel.x < 0) {\r\n            // mario is going toward LEFT\r\n            // else we only need to check the LEFT side of entity\r\n            x = entity.bounds.left;\r\n        } else {\r\n            return;\r\n        }\r\n\r\n        const matches = this.tile.searchByRange(\r\n            entity.bounds.left, entity.bounds.right,\r\n           entity.bounds.top, entity.bounds.bottom\r\n        );\r\n\r\n        matches.forEach(match => {\r\n            if (match.tile.type === \'death-border\') {\r\n                entity.killable.kill();\r\n            }\r\n\r\n            if (match.tile.type !== \'ground\') {\r\n                return;\r\n            }\r\n\r\n            if (entity.vel.x > 0) {\r\n                if (entity.bounds.right > match.x1) {\r\n                    entity.obstruct(__WEBPACK_IMPORTED_MODULE_1__Entity_js__["a" /* Sides */].LEFT, match);\r\n                }\r\n            } else if (entity.vel.x < 0) {\r\n                if (entity.bounds.left < match.x2) {\r\n                    entity.obstruct(__WEBPACK_IMPORTED_MODULE_1__Entity_js__["a" /* Sides */].RIGHT, match);\r\n                }\r\n            }\r\n        })\r\n\r\n    }\r\n\r\n    checkY(entity) {\r\n        let y;\r\n        if (entity.vel.y > 0) {\r\n            // mario is going toward B\r\n            y = entity.bounds.bottom;\r\n        } else if (entity.vel.y < 0) {\r\n            // mario is going toward TOP\r\n            y =entity.bounds.top;\r\n        } else {\r\n            return;\r\n        }\r\n\r\n        const matches = this.tile.searchByRange(\r\n            entity.bounds.left, entity.bounds.right,\r\n            entity.bounds.top, entity.bounds.bottom\r\n        );\r\n\r\n        matches.forEach(match => {\r\n            if (match.tile.type === \'death-border\') {\r\n                entity.killable.kill();\r\n            }\r\n\r\n            if (match.tile.type !== \'ground\') {\r\n                return;\r\n            }\r\n\r\n            if (entity.vel.y > 0) {\r\n                if (entity.bounds.bottom > match.y1) {\r\n                    entity.obstruct(__WEBPACK_IMPORTED_MODULE_1__Entity_js__["a" /* Sides */].BOTTOM, match);\r\n                }\r\n            } else if (entity.vel.y < 0) {\r\n                if (entity.pos.y < match.y2) {\r\n                    entity.obstruct(__WEBPACK_IMPORTED_MODULE_1__Entity_js__["a" /* Sides */].TOP, match);\r\n                }\r\n            }\r\n        })\r\n\r\n    }\r\n\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = TileCollider;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/TileCollider.js\n// module id = 22\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/TileCollider.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('class BoundingBox {\r\n    constructor(pos, size, offset) {\r\n        this.pos = pos;\r\n        this.size = size;\r\n        this.offset = offset;\r\n    }\r\n\r\n    overlaps(box) {\r\n        return this.bottom > box.top\r\n                     && this.top < box.bottom\r\n                     && this.left < box.right\r\n                     && this.right > box.left\r\n    }\r\n\r\n    get bottom() {\r\n        return this.pos.y + this.size.y + this.offset.y;\r\n    }\r\n\r\n    set bottom(y) {\r\n        this.pos.y = y - (this.size.y + this.offset.y);\r\n    }\r\n\r\n    get top() {\r\n        return this.pos.y + this.offset.y;\r\n    }\r\n\r\n    set top(y) {\r\n        this.pos.y = y - this.offset.y;\r\n    }\r\n\r\n    get left() {\r\n        return this.pos.x + this.offset.x;\r\n    }\r\n\r\n    set left(x) {\r\n        this.pos.x = x - this.offset.x;\r\n    }\r\n\r\n    get right() {\r\n        return this.pos.x + this.size.x + this.offset.x;\r\n    }\r\n\r\n    set right(x) {\r\n        this.pos.x = x - (this.size.x + this.offset.x);\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = BoundingBox;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/BoundingBox.js\n// module id = 23\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/BoundingBox.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('class EvenEmitter {\r\n    constructor() {\r\n        this.listners = []\r\n    }\r\n\r\n    listen(name, callback) {\r\n        this.listners.push({\r\n            name,\r\n            callback\r\n        })\r\n    }\r\n\r\n    emit(name, ...payload) {\r\n        this.listners.forEach((listener) => {\r\n            if (listener.name === name) {\r\n                listener.callback(...payload)\r\n            }\r\n        })\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = EvenEmitter;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/EventEmitter.js\n// module id = 24\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/EventEmitter.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('class MusicController {\r\n    constructor() {\r\n        this.player = null\r\n    }\r\n\r\n    setPlayer(player) {\r\n        this.player = player\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = MusicController;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/MusicController.js\n// module id = 25\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/MusicController.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("/* harmony export (immutable) */ __webpack_exports__[\"a\"] = createSpriteLayer;\nfunction createSpriteLayer(entities, width = 64, height = 64) {\r\n    const spriteBuffer = document.createElement('canvas')\r\n    spriteBuffer.width = width;\r\n    spriteBuffer.height = height;\r\n\r\n    const spriteContext = spriteBuffer.getContext('2d');\r\n    return function drawSpriteLayer(context, camera) {\r\n        entities.forEach(entity => {\r\n            spriteContext.clearRect(0, 0, width, height);   // set background to transparent.\r\n            entity.draw(spriteContext);\r\n\r\n            context.drawImage(\r\n                spriteBuffer,\r\n                entity.pos.x - camera.pos.x,\r\n                entity.pos.y - camera.pos.y\r\n            )\r\n        })\r\n    }\r\n}\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/layers/sprites.js\n// module id = 26\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/layers/sprites.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("/* harmony export (immutable) */ __webpack_exports__[\"a\"] = createBackgroundLayer;\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__TileResolver_js__ = __webpack_require__(7);\n\r\n\r\nfunction createBackgroundLayer(level, tiles, sprites) {\r\n    const resolver = new __WEBPACK_IMPORTED_MODULE_0__TileResolver_js__[\"a\" /* default */](tiles);\r\n\r\n    const buffer = document.createElement('canvas');\r\n    buffer.width = 256 + 16;    // 16 + 1 column\r\n    buffer.height = 240;\r\n\r\n    const context = buffer.getContext('2d');\r\n\r\n    function redraw(startIndex, endIndex) {\r\n\r\n        context.clearRect(0,0,buffer.width,buffer.height);\r\n\r\n        for (let x = startIndex; x <= endIndex; x++) {\r\n            const col = tiles.grid[x];\r\n            if (col) {\r\n                // console.log(x - startIndex);\r\n                /*TODO Cannot figure out the mean of x - startIndex and -camera.pos.x % 16 OPTIMIZATION in EP 6*/\r\n                col.forEach((tile, y) => {\r\n                    if (sprites.animations.has(tile.name)) {\r\n                        sprites.drawAnim(\r\n                            tile.name,\r\n                            context,\r\n                            x - startIndex,\r\n                            y,\r\n                            level.totalTime);\r\n                    } else {\r\n                        sprites.drawTile(\r\n                            tile.name,\r\n                            context,\r\n                            x - startIndex,\r\n                            y);\r\n                    }\r\n                })\r\n            }\r\n        }\r\n    }\r\n\r\n    return function drawBackgroundLayer(context, camera) {\r\n        const drawWidth = resolver.toIndex(camera.size.x),\r\n            drawFrom = resolver.toIndex(camera.pos.x);\r\n        const drawEnd = drawFrom + drawWidth;\r\n\r\n        redraw(drawFrom, drawEnd);\r\n\r\n        context.drawImage(\r\n            buffer,\r\n            -camera.pos.x % 16,\r\n            -camera.pos.y);\r\n    }\r\n\r\n    // // High-Order Function\r\n    // return function drawBackgroundLayer(context, camera) {\r\n    //     context.drawImage(buffer, -camera.pos.x, -camera.pos.y);\r\n    // }\r\n}\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/layers/background.js\n// module id = 27\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/layers/background.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony export (immutable) */ __webpack_exports__["a"] = loadMusicSheet;\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__loader_js__ = __webpack_require__(1);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__MusicPlayer__ = __webpack_require__(29);\n\r\n\r\n\r\nfunction loadMusicSheet(name) {\r\n    return Object(__WEBPACK_IMPORTED_MODULE_0__loader_js__["c" /* loadJSON */])(`/assets/sound/${name}.json`)\r\n        .then(musicSheet => {\r\n            // console.log(musicSheet)\r\n            const musicPlayer = new __WEBPACK_IMPORTED_MODULE_1__MusicPlayer__["a" /* default */]()\r\n            for (const [name, track] of Object.entries(musicSheet)) {\r\n                musicPlayer.addTrack(name, track.url)\r\n            }\r\n\r\n            return musicPlayer\r\n        })\r\n}\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/loaders/music.js\n// module id = 28\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/loaders/music.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('class MusicPlayer {\r\n    constructor() {\r\n        this.tracks = new Map()\r\n    }\r\n\r\n    addTrack(name, url) {\r\n        const audio = new Audio()\r\n        audio.loop = true\r\n        audio.src = url\r\n        this.tracks.set(name, audio)\r\n    }\r\n\r\n    playTrack(name) {\r\n        const audio = this.tracks.get(name)\r\n        audio.play()\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = MusicPlayer;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/MusicPlayer.js\n// module id = 29\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/MusicPlayer.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony export (immutable) */ __webpack_exports__["a"] = createAnim;\nfunction createAnim(frames, frameLen) {\r\n    return function resolveFrame(distance) {\r\n        const frameIndex = Math.floor(distance / frameLen) % frames.length;\r\n\r\n        return frames[frameIndex];\r\n    }\r\n}\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/anim.js\n// module id = 30\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/anim.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony export (immutable) */ __webpack_exports__["a"] = loadFont;\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__loader_js__ = __webpack_require__(1);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__SpriteSheet_js__ = __webpack_require__(9);\n\r\n\r\n\r\nconst CHARS = \' !"#$%&\\\'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\\\]^_`abcdefghijklmnopqrstuvwxyz{|}~\';\r\n\r\n\r\nclass Font {\r\n    constructor(spriteSheet, size) {\r\n        this.sprites = spriteSheet;\r\n        this.size = size;\r\n    }\r\n\r\n    print(text, context, x, y) {\r\n        [...text].forEach((char, pos) => {\r\n            this.sprites.draw(char, context, x + pos * this.size, y);\r\n        })\r\n    }\r\n}\r\n\r\nfunction loadFont() {\r\n    return Object(__WEBPACK_IMPORTED_MODULE_0__loader_js__["b" /* loadImage */])(\'./assets/img/font.png\')\r\n        .then(img => {\r\n            const fontSprite = new __WEBPACK_IMPORTED_MODULE_1__SpriteSheet_js__["a" /* default */](img);\r\n\r\n            const size = 8, rowLen = img.width;\r\n            const colNum = img.width / size;\r\n            for (let [index, char] of [...CHARS].entries()) {\r\n\r\n                const x  = (index * size) % rowLen;\r\n                const y = Math.floor(index / colNum)*size;\r\n\r\n                fontSprite.define(char, x, y, size, size);\r\n            }\r\n\r\n            return new Font(fontSprite, size);\r\n        })\r\n}\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/loaders/font.js\n// module id = 31\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/loaders/font.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony export (immutable) */ __webpack_exports__["a"] = loadEntities;\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__entities_Mario_js__ = __webpack_require__(33);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__entities_Goomba_js__ = __webpack_require__(38);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2__entities_Koopa_js__ = __webpack_require__(39);\n\r\n\r\n\r\n\r\nfunction loadEntities(audioContext) {\r\n    const entitiesFactory = {};\r\n\r\n    function addAs(name) {\r\n        return factory => {entitiesFactory[name] = factory}\r\n    }\r\n\r\n    return Promise.all([\r\n        Object(__WEBPACK_IMPORTED_MODULE_0__entities_Mario_js__["a" /* loadMario */])(audioContext).then(addAs(\'mario\')),\r\n        Object(__WEBPACK_IMPORTED_MODULE_1__entities_Goomba_js__["a" /* loadGoomba */])(audioContext).then(addAs(\'goomba\')),\r\n        Object(__WEBPACK_IMPORTED_MODULE_2__entities_Koopa_js__["a" /* loadKoopa */])(audioContext).then(addAs(\'koopa\')),\r\n    ])\r\n        .then(() => entitiesFactory)\r\n}\r\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/entities.js\n// module id = 32\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/entities.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony export (immutable) */ __webpack_exports__["a"] = loadMario;\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__Entity_js__ = __webpack_require__(0);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__traits_Go_js__ = __webpack_require__(34);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2__traits_Jump_js__ = __webpack_require__(35);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_3__traits_Stomer_js__ = __webpack_require__(36);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_4__traits_Killable_js__ = __webpack_require__(4);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_5__traits_Solid_js__ = __webpack_require__(5);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_6__traits_Physics_js__ = __webpack_require__(6);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_7__loaders_sprite_js__ = __webpack_require__(3);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_8__loaders_audio__ = __webpack_require__(37);\n\r\n// import Velocity from \'../traits/Velocity.js\'\r\n\r\n\r\n\r\n\r\n\r\n\r\n// import PlayerController from \'../traits/PlayerController.js\'\r\n\r\n\r\n\r\n/*Name Convention:\r\n* 1. loadSomething is synchronous, createSomething is asynchronous.*/\r\n\r\nfunction loadMario(audioContext) {\r\n    // loadAudioBoard(\'mario\', audioContext)\r\n    //     .then(audioBoard => {\r\n    //         console.log(audioBoard)\r\n    //     })\r\n    // return loadSpriteSheet(\'mario\')\r\n    //     .then(createMarioFactory)\r\n    //     // .then((sprite) => {\r\n    //     //     return createMarioFactory(sprite)\r\n    //     // })\r\n\r\n    return Promise.all([\r\n        Object(__WEBPACK_IMPORTED_MODULE_7__loaders_sprite_js__["a" /* loadSpriteSheet */])(\'mario\'),\r\n        Object(__WEBPACK_IMPORTED_MODULE_8__loaders_audio__["a" /* loadAudioBoard */])(\'mario\', audioContext),\r\n    ])\r\n        .then(([sprite, audio]) => {\r\n            return createMarioFactory(sprite, audio)\r\n        })\r\n}\r\n\r\nfunction createMarioFactory(sprite, audio) {\r\n    const runAnim = sprite.animations.get("run");\r\n\r\n        function frameRoute(mario) {\r\n        if (mario.jump.falling) {\r\n            return \'jump\';\r\n        }\r\n\r\n        if (mario.go.distance > 0) {\r\n            if ((mario.vel.x > 0 && mario.go.dir < 0) ||\r\n                (mario.vel.x < 0 && mario.go.dir > 0)) {\r\n                return \'break\';\r\n            }\r\n\r\n            return runAnim(mario.go.distance);\r\n        }\r\n\r\n        return \'idle\';\r\n    }\r\n\r\n    function drawMario(context) {\r\n        sprite.draw(frameRoute(this), context, 0, 0, this.go.heading < 0);\r\n    }\r\n\r\n    return function createMario() {\r\n        const mario = new __WEBPACK_IMPORTED_MODULE_0__Entity_js__["c" /* default */]();\r\n        mario.audio = audio\r\n        mario.size.set(14, 16);\r\n\r\n        mario.addTrait(new __WEBPACK_IMPORTED_MODULE_6__traits_Physics_js__["a" /* default */]());\r\n        mario.addTrait(new __WEBPACK_IMPORTED_MODULE_5__traits_Solid_js__["a" /* default */]());\r\n        mario.addTrait(new __WEBPACK_IMPORTED_MODULE_1__traits_Go_js__["a" /* default */]());\r\n        mario.addTrait(new __WEBPACK_IMPORTED_MODULE_2__traits_Jump_js__["a" /* default */]());\r\n        mario.addTrait(new __WEBPACK_IMPORTED_MODULE_3__traits_Stomer_js__["a" /* default */]());\r\n        mario.addTrait(new __WEBPACK_IMPORTED_MODULE_4__traits_Killable_js__["a" /* default */]());\r\n        // mario.addTrait(new PlayerController());\r\n\r\n        mario.killable.removeAfter = 0;\r\n        // mario.playerController.setPlayer(mario);\r\n\r\n        mario.draw = drawMario;\r\n\r\n        return mario;\r\n    }\r\n}\r\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/entities/Mario.js\n// module id = 33\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/entities/Mario.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__Entity_js__ = __webpack_require__(0);\n\r\n\r\n/*extends keyword can be used to inherit all the properties and methods. */\r\nclass Go extends __WEBPACK_IMPORTED_MODULE_0__Entity_js__["b" /* Trait */] {\r\n    constructor() {\r\n        /*super keyword in here means the father class\'s constructor of this class. */\r\n        super(\'go\');\r\n\r\n        this.dir = 0;\r\n        this.acceleration = 400;\r\n        this.deceleration = 300;\r\n        this.dragFactor = 1/5000;\r\n\r\n        this.distance = 0;\r\n        this.heading = 1;\r\n    }\r\n\r\n    update(entity, { deltaTime }) {\r\n        const absX = Math.abs(entity.vel.x);\r\n\r\n        if (this.dir !== 0) {\r\n            entity.vel.x += this.acceleration * deltaTime * this.dir;\r\n            if (entity.jump) {\r\n                if (!entity.jump.falling) {\r\n                    this.heading = this.dir;\r\n                }\r\n            } else {\r\n                this.heading = this.dir;\r\n            }\r\n        } else if (entity.vel.x !== 0) {\r\n            const decel = Math.min(absX, this.deceleration * deltaTime);\r\n            entity.vel.x += entity.vel.x > 0 ? -decel : decel;\r\n        } else {\r\n            this.distance = 0;\r\n        }\r\n\r\n        const drag = this.dragFactor * entity.vel.x * absX;\r\n        entity.vel.x -= drag;\r\n\r\n        this.distance += absX * deltaTime;\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = Go;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/traits/Go.js\n// module id = 34\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/traits/Go.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__Entity_js__ = __webpack_require__(0);\n\r\n\r\n/*extends keyword can be used to inherit all the properties and methods. */\r\nclass Jump extends __WEBPACK_IMPORTED_MODULE_0__Entity_js__[\"b\" /* Trait */] {\r\n    constructor() {\r\n        /*super keyword in here means the father class's constructor of this class. */\r\n        super('jump');\r\n\r\n        this.duration = 0.3;\r\n        this.velocity = 200;\r\n        this.engageTime = 0; // total time allow to  pressing key\r\n        this.ready = 0;\r\n        this.gracePeriod = 0.1;\r\n        this.requestTime = 0;\r\n        this.speedBoost = 0.3;\r\n    }\r\n\r\n    get falling() {\r\n        return this.ready < 0;\r\n    }\r\n\r\n    start() {\r\n        // if (this.ready > 0) {\r\n        //     this.engageTime = this.duration;\r\n        // }\r\n        this.requestTime = this.gracePeriod;\r\n    }\r\n\r\n    cancel() {\r\n        this.engageTime = 0;\r\n        this.requestTime = 0;\r\n    }\r\n\r\n    obstruct(entity, side) {\r\n        if (side === __WEBPACK_IMPORTED_MODULE_0__Entity_js__[\"a\" /* Sides */].BOTTOM) {\r\n            this.ready = 1;\r\n        } else if (side === __WEBPACK_IMPORTED_MODULE_0__Entity_js__[\"a\" /* Sides */].TOP) {\r\n            this.cancel();\r\n        }\r\n    }\r\n\r\n    update(entity, { deltaTime, audioContext }) {\r\n        if (this.requestTime > 0) {\r\n            if (this.ready > 0) {\r\n                entity.sounds.add('jump')\r\n                // entity.audio.playAudio('jump', audioContext)\r\n                this.engageTime = this.duration;\r\n                this.requestTime = 0;\r\n            }\r\n\r\n            this.requestTime -= deltaTime;\r\n        }\r\n\r\n        if (this.engageTime > 0) {\r\n            entity.vel.y = -(this.velocity + Math.abs(entity.vel.x) * this.speedBoost);\r\n            /*If keep pressing the key, the engageTime (total time allow to  pressing key ) will decrease in a row until less than 0, which means the total time of pressing a key is bigger than the allow duration( this. duration = 0.5 (second)), so the entity.vel.y should not decrease anymore, in other words, the mario should not travel up anymore.*/\r\n            this.engageTime -= deltaTime;\r\n        }\r\n\r\n        // console.log('If we are ready to jump?', this.ready)\r\n        this.ready --;\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__[\"a\"] = Jump;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/traits/Jump.js\n// module id = 35\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/traits/Jump.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__Entity_js__ = __webpack_require__(0);\n\r\n\r\nclass Stomer extends __WEBPACK_IMPORTED_MODULE_0__Entity_js__[\"b\" /* Trait */] {\r\n    constructor() {\r\n        super('stomer');\r\n        this.bounceSpeed = 400;\r\n\r\n        this.onStomp = function () {\r\n        }\r\n    }\r\n\r\n    bounce(us, them) {\r\n        us.bounds.bottom = them.bounds.top;\r\n        us.vel.y = -this.bounceSpeed;\r\n    }\r\n\r\n    collides(us, them) {\r\n        /*此处是否反弹跳跃（bounce）的判断严重依赖事件（kill，collide等）的触发顺序。\r\n        * 我们可以选择通过一些细微的改动---来调整顺序，但是！过于依赖这种细微的改动不利以后续项目的扩展。\r\n        * 所以我们需要更健壮的解决方案。*/\r\n        if (!them.killable || them.killable.dead) {\r\n            return;\r\n        }\r\n\r\n        if ( us.vel.y > them.vel.y) {\r\n            this.bounce(us, them);\r\n            // this.didStomp = true\r\n            us.sounds.add('stomp')\r\n            // this.onStomp(us, them);\r\n            this.events.emit('stomp')\r\n        }\r\n    }\r\n\r\n    // remove the didStomp in update is the profit we gain from this.sounds\r\n    // update(entity, { audioContext }) {\r\n    //     if (this.didStomp) {\r\n    //         // entity.audio.playAudio('stomp', audioContext)\r\n    //         this.didStomp = false\r\n    //     }\r\n    // }\r\n}\n/* harmony export (immutable) */ __webpack_exports__[\"a\"] = Stomer;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/traits/Stomer.js\n// module id = 36\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/traits/Stomer.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("/* harmony export (immutable) */ __webpack_exports__[\"a\"] = loadAudioBoard;\n/* unused harmony export createAudioLoader */\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__loader__ = __webpack_require__(1);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__AudioBoard__ = __webpack_require__(8);\n/*\r\n    const audioContext = new window.AudioContext()\r\n    const audioBoard = new AudioBoard(audioContext)\r\n    const loadAudio = createAudioLoader(audioContext)\r\n    loadAudio('/assets/audio/stomp.ogg')\r\n        .then(buffer => {\r\n            console.log(buffer)\r\n            audioBoard.addAudio('stomp', buffer)\r\n        })\r\n    loadAudio('/assets/audio/jump.ogg')\r\n        .then(buffer => {\r\n            console.log(buffer)\r\n            audioBoard.addAudio('jump', buffer)\r\n        })\r\n* */\r\n\r\n\r\n\r\n\r\nfunction loadAudioBoard(name, audioContext) {\r\n    const loadAudio = createAudioLoader(audioContext)\r\n    return Object(__WEBPACK_IMPORTED_MODULE_0__loader__[\"c\" /* loadJSON */])(`/assets/sound/${name}.json`)\r\n        .then(audioSheet => {\r\n            // console.log(audioSheet)\r\n            // console.log(audioContext)\r\n            const audioBoard = new __WEBPACK_IMPORTED_MODULE_1__AudioBoard__[\"a\" /* default */]()\r\n            const fx = audioSheet.fx\r\n            const jobs = []\r\n            Object.keys(fx).forEach(name => {\r\n                const url = fx[name].url\r\n                const job = loadAudio(url)\r\n                    .then(audioBuffer => {\r\n                        audioBoard.addAudio(name, audioBuffer)\r\n                    })\r\n                jobs.push(job)\r\n            })\r\n            return Promise.all(jobs)\r\n                .then(() => audioBoard)\r\n        })\r\n}\r\n\r\nfunction createAudioLoader(context) {\r\n    return function loadAudio(url) {\r\n        return fetch(__WEBPACK_IMPORTED_MODULE_0__loader__[\"a\" /* PUBLIC_PATH */] + url)\r\n            .then(resp => {\r\n                return resp.arrayBuffer()\r\n            })\r\n            .then(arrayBuffer => {\r\n                return context.decodeAudioData(arrayBuffer)\r\n            })\r\n    }\r\n\r\n}\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/loaders/audio.js\n// module id = 37\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/loaders/audio.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony export (immutable) */ __webpack_exports__["a"] = loadGoomba;\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__Entity_js__ = __webpack_require__(0);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__loaders_sprite_js__ = __webpack_require__(3);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2__traits_PendulumMove_js__ = __webpack_require__(10);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_3__traits_Killable_js__ = __webpack_require__(4);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_4__traits_Solid_js__ = __webpack_require__(5);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_5__traits_Physics_js__ = __webpack_require__(6);\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nfunction loadGoomba() {\r\n    return Object(__WEBPACK_IMPORTED_MODULE_1__loaders_sprite_js__["a" /* loadSpriteSheet */])(\'goomba\')\r\n        .then(createGoombaFactory)\r\n}\r\n\r\nclass Behavior extends __WEBPACK_IMPORTED_MODULE_0__Entity_js__["b" /* Trait */] {\r\n    constructor() {\r\n        super(\'behavior\');\r\n    }\r\n\r\n    collides(us, them) {\r\n        // us is our goomba, them often are mario.\r\n        if (us.killable.dead) {\r\n            return;\r\n        }\r\n\r\n        if (them.stomer) {\r\n            if (them.vel.y > us.vel.y) {\r\n                us.killable.kill();\r\n                us.pendulumMove.speed = 0;\r\n            } else {\r\n                them.killable.kill();\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nfunction createGoombaFactory(sprite) {\r\n    const walkAnim = sprite.animations.get(\'walk\');\r\n\r\n    function routeAnim(goomba) {\r\n        if (goomba.killable.dead) {\r\n            return \'flat\';\r\n        }\r\n\r\n        return walkAnim(goomba.lifeTime);\r\n    }\r\n\r\n    function drawGoomba(context) {\r\n        sprite.draw(routeAnim(this), context, 0, 0);\r\n    }\r\n\r\n    return function createGoomba() {\r\n        const goomba = new __WEBPACK_IMPORTED_MODULE_0__Entity_js__["c" /* default */]();\r\n        goomba.size.set(16, 16);\r\n\r\n        goomba.addTrait(new __WEBPACK_IMPORTED_MODULE_5__traits_Physics_js__["a" /* default */]());\r\n        goomba.addTrait(new __WEBPACK_IMPORTED_MODULE_4__traits_Solid_js__["a" /* default */]());\r\n        goomba.addTrait(new __WEBPACK_IMPORTED_MODULE_2__traits_PendulumMove_js__["a" /* default */]());\r\n        goomba.addTrait(new Behavior());\r\n        goomba.addTrait(new __WEBPACK_IMPORTED_MODULE_3__traits_Killable_js__["a" /* default */]());\r\n\r\n        goomba.draw = drawGoomba;\r\n\r\n        return goomba;\r\n    }\r\n}\r\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/entities/Goomba.js\n// module id = 38\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/entities/Goomba.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("/* harmony export (immutable) */ __webpack_exports__[\"a\"] = loadKoopa;\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__Entity_js__ = __webpack_require__(0);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__loaders_sprite_js__ = __webpack_require__(3);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2__traits_PendulumMove_js__ = __webpack_require__(10);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_3__traits_Solid_js__ = __webpack_require__(5);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_4__traits_Physics_js__ = __webpack_require__(6);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_5__traits_Killable_js__ = __webpack_require__(4);\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nfunction loadKoopa() {\r\n    return Object(__WEBPACK_IMPORTED_MODULE_1__loaders_sprite_js__[\"a\" /* loadSpriteSheet */])('koopa')\r\n        .then(createKoopaFactory)\r\n}\r\n\r\nconst STATE_WALKING = Symbol('walking');\r\nconst STATE_HIDING = Symbol('hiding');\r\nconst STATE_PANIC = Symbol('panic');\r\n\r\nclass Behavior extends __WEBPACK_IMPORTED_MODULE_0__Entity_js__[\"b\" /* Trait */] {\r\n    constructor() {\r\n        super('behavior');\r\n        this.state = STATE_WALKING;\r\n        this.hideTime = 0;\r\n        this.hideDuration = 3;\r\n        this.panicSpeed = 200;\r\n        this.walkSpeed = null;\r\n    }\r\n\r\n    collides(us, them) {\r\n        // us is our goomba, them often are mario.\r\n        if (us.killable.dead) {\r\n            return;\r\n        }\r\n\r\n        if (them.stomer) {\r\n            if (them.vel.y > us.vel.y) {\r\n                this.handleState(us, them);\r\n            } else {\r\n                this.handleKick(us, them);\r\n            }\r\n        }\r\n    }\r\n\r\n    handleKick(us, them) {\r\n        if (this.state === STATE_WALKING) {\r\n            them.killable.kill();\r\n        } else if (this.state === STATE_HIDING) {\r\n            this.panic(us, them);\r\n        } else if (this.state === STATE_PANIC) {\r\n            const travelDir = Math.sign(us.vel.x);\r\n            const impactDir = Math.sign(us.pos.x - them.pos.x);\r\n            if (travelDir !== 0 && impactDir !== travelDir) {\r\n                them.killable.kill();\r\n            }\r\n        }\r\n    }\r\n\r\n    handleState(us, them) {\r\n        if (this.state === STATE_WALKING) {\r\n            if (us.pendulumMove.speed !== 0) {\r\n                this.walkSpeed = us.pendulumMove.speed;\r\n            }\r\n            this.hiding(us);\r\n        } else if (this.state === STATE_HIDING) {\r\n            us.killable.kill();\r\n            us.vel.set(100, -200);\r\n            us.solid.obstructs = false;\r\n        } else if (this.state === STATE_PANIC) {\r\n            this.hiding(us);\r\n        }\r\n    }\r\n\r\n    hiding(us) {\r\n        us.vel.x = 0;\r\n        us.pendulumMove.enable = false;\r\n        this.state = STATE_HIDING;\r\n    }\r\n\r\n    unHide(us) {\r\n        us.vel.x = 100;\r\n        us.pendulumMove.enable = true;\r\n        us.pendulumMove.speed = this.walkSpeed;\r\n        this.state = STATE_WALKING;\r\n        this.hideTime = 0;\r\n    }\r\n\r\n    panic(us, them) {\r\n        us.pendulumMove.enable = true;\r\n        us.pendulumMove.speed = this.panicSpeed * Math.sign(them.vel.x);\r\n        this.state = STATE_PANIC;\r\n    }\r\n\r\n    update(us, {deltaTime}) {\r\n        if (this.state === STATE_HIDING) {\r\n            this.hideTime += deltaTime;\r\n\r\n            if (this.hideTime > this.hideDuration) {\r\n                this.unHide(us);\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nfunction createKoopaFactory(sprite) {\r\n    const walkAnim = sprite.animations.get('walk');\r\n    const wakeAnim = sprite.animations.get('wake');\r\n\r\n\r\n    function routeAnim(koopa) {\r\n        if (koopa.behavior.state === STATE_HIDING) {\r\n            if (koopa.behavior.hideTime > 2) {\r\n                return wakeAnim(koopa.behavior.hideTime);\r\n            }\r\n            return 'hiding';\r\n        }\r\n        if (koopa.behavior.state === STATE_PANIC) {\r\n            return 'hiding'\r\n        }\r\n\r\n        return walkAnim(koopa.lifeTime);\r\n    }\r\n\r\n    function drawKoopa(context) {\r\n        sprite.draw(routeAnim(this), context, 0, 0, this.vel.x < 0);\r\n    }\r\n\r\n    return function createKoopa() {\r\n        const koopa = new __WEBPACK_IMPORTED_MODULE_0__Entity_js__[\"c\" /* default */]();\r\n        koopa.size.set(16, 16);\r\n        koopa.offset.y = 8;\r\n\r\n        koopa.addTrait(new __WEBPACK_IMPORTED_MODULE_4__traits_Physics_js__[\"a\" /* default */]());\r\n        koopa.addTrait(new __WEBPACK_IMPORTED_MODULE_3__traits_Solid_js__[\"a\" /* default */]());\r\n        koopa.addTrait(new __WEBPACK_IMPORTED_MODULE_2__traits_PendulumMove_js__[\"a\" /* default */]());\r\n        koopa.addTrait(new Behavior());\r\n        koopa.addTrait(new __WEBPACK_IMPORTED_MODULE_5__traits_Killable_js__[\"a\" /* default */]());\r\n\r\n        koopa.draw = drawKoopa;\r\n\r\n        return koopa;\r\n    }\r\n}\r\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/entities/Koopa.js\n// module id = 39\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/entities/Koopa.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("/* harmony export (immutable) */ __webpack_exports__[\"a\"] = createDashboardLayer;\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__polyfills_addPadStart_js__ = __webpack_require__(41);\n\r\n\r\nfunction createDashboardLayer(font, playerEnv, isWaitingScreen) {\r\n    const LINE1 = font.size;\r\n    const LINE2 = font.size*2;\r\n\r\n    const coins = 99;\r\n\r\n    Object(__WEBPACK_IMPORTED_MODULE_0__polyfills_addPadStart_js__[\"a\" /* addPadStartPolyfill */])();\r\n\r\n    return function drawDashboard(context) {\r\n        let time = playerEnv.playerController.time;\r\n        const {score} = playerEnv.playerController;\r\n\r\n        //TODO:IMPROVE time counter\r\n        if (time <= 0) {\r\n            playerEnv.playerController.time = time = 300;\r\n        }\r\n\r\n        font.print('MARIO', context,16, LINE1);\r\n        font.print(score.toString().padStart(6, '0'), context,16, LINE2);\r\n\r\n        font.print('@x' + coins.toString().padStart(2, '0'), context,96, LINE2);\r\n\r\n        font.print('WORLD', context,152, LINE1);\r\n        font.print('1-1', context,160, LINE2);\r\n\r\n        font.print('TIME', context,208, LINE1);\r\n        if (!isWaitingScreen) {\r\n            font.print(time.toFixed().toString().padStart(3, '0'), context,216, LINE2)\r\n        }\r\n    }\r\n}\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/layers/dashboard.js\n// module id = 40\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/layers/dashboard.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("/* harmony export (immutable) */ __webpack_exports__[\"a\"] = addPadStartPolyfill;\n// https://github.com/uxitten/polyfill/blob/master/string.polyfill.js\r\n// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/padStart\r\n\r\nfunction addPadStartPolyfill() {\r\n    // add String.prototype.padStart for firefox-v47\r\n    if (!String.prototype.padStart) {\r\n        String.prototype.padStart = function padStart(targetLength,padString) {\r\n            targetLength = targetLength>>0; //floor if number or convert non-number to 0;\r\n            padString = String(padString || ' ');\r\n            if (this.length > targetLength) {\r\n                return String(this);\r\n            }\r\n            else {\r\n                targetLength = targetLength-this.length;\r\n                if (targetLength > padString.length) {\r\n                    padString += padString.repeat(targetLength/padString.length); //append to original to ensure we are longer than needed\r\n                }\r\n                return padString.slice(0,targetLength) + String(this);\r\n            }\r\n        };\r\n    }\r\n}\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/polyfills/addPadStart.js\n// module id = 41\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/polyfills/addPadStart.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("/* harmony export (immutable) */ __webpack_exports__[\"b\"] = setupTouchPad;\n/* harmony export (immutable) */ __webpack_exports__[\"a\"] = setupKeyboard;\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__KeyboardState_js__ = __webpack_require__(43);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__TouchPadState_js__ = __webpack_require__(44);\n\r\n\r\n\r\nfunction setupTouchPad(entity) {\r\n    const jumpBtn = document.getElementById('jump-btn');\r\n    const leftBtn = document.getElementById('left-btn');\r\n    const rightBtn = document.getElementById('right-btn');\r\n\r\n    const buttons = [jumpBtn, leftBtn, rightBtn];\r\n\r\n    const input = new __WEBPACK_IMPORTED_MODULE_1__TouchPadState_js__[\"a\" /* default */](buttons);\r\n\r\n    input.startListenTo();\r\n\r\n    input.addMapping('jump-btn', keyState => {\r\n        if (keyState) {\r\n            entity.jump.start();\r\n        } else {\r\n            entity.jump.cancel();\r\n        }\r\n    });\r\n\r\n    input.addMapping('right-btn', keyState => {\r\n        entity.go.dir += keyState ? 1 : -1;\r\n    });\r\n\r\n    input.addMapping('left-btn', keyState => {\r\n        entity.go.dir += keyState ? -1 : 1;\r\n    });\r\n\r\n}\r\n\r\nfunction setupKeyboard(entity) {\r\n    const input = new __WEBPACK_IMPORTED_MODULE_0__KeyboardState_js__[\"a\" /* default */]();\r\n\r\n    input.addMapping('Space', keyState => {\r\n        // Fantastic! - 妙！\r\n        /*By such a fantastic Class, now we take over the event of key board input,\r\n         so that we can get how long a key is pressed and draw the canvas semantically.*/\r\n        if (keyState) {\r\n            entity.jump.start();\r\n        } else {\r\n            entity.jump.cancel();\r\n        }\r\n    });\r\n\r\n    input.addMapping('ArrowUp', keyState => {\r\n        if (keyState) {\r\n            entity.jump.start();\r\n        } else {\r\n            entity.jump.cancel();\r\n        }\r\n    });\r\n\r\n    // input.addMapping('KeyO', keyState => {\r\n    //     // Ep8 - Turbo Mode, I think it is unnecessary.\r\n    // });\r\n\r\n    input.addMapping('ArrowRight', keyState => {\r\n        entity.go.dir += keyState ? 1 : -1;\r\n    });\r\n\r\n    input.addMapping('ArrowLeft', keyState => {\r\n        entity.go.dir += keyState ? -1 : 1;\r\n    });\r\n\r\n    return input;\r\n}\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/input/input.js\n// module id = 42\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/input/input.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("const PRESSED = 1, RELEASED = 0;\r\n\r\nclass KeyboardState {\r\n    constructor() {\r\n        // hold the current state of a given key\r\n        this.keyStates = new Map();\r\n\r\n        // holds the callback functions for a key code\r\n        this.keyMap = new Map()\r\n    }\r\n\r\n    addMapping(code, callBack) {\r\n        this.keyMap.set(code, callBack)\r\n    }\r\n\r\n    handleEvent(event) {\r\n        const {code} = event;\r\n\r\n        if (!this.keyMap.has(code)) {\r\n            return;\r\n        }\r\n\r\n        event.preventDefault();\r\n\r\n        const keyState = event.type === 'keydown' ? PRESSED : RELEASED;\r\n\r\n        if (this.keyStates.get(code) === keyState) {\r\n            // avoid triggering multiple times\r\n            return;\r\n        }\r\n\r\n        this.keyStates.set(code, keyState);\r\n\r\n        this.keyMap.get(code)(keyState);\r\n    }\r\n\r\n    listenTo(window) {\r\n        ['keydown', 'keyup'].forEach(eventName => {\r\n            window.addEventListener(eventName, event => {\r\n                this.handleEvent(event)\r\n            })\r\n        })\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__[\"a\"] = KeyboardState;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/input/KeyboardState.js\n// module id = 43\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/input/KeyboardState.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("const PRESSED = 1, RELEASED = 0;\r\n\r\nclass TouchPadState {\r\n    constructor(buttons) {\r\n        this.buttons = buttons;\r\n\r\n        this.keyStates = new Map();\r\n\r\n        this.keyMap = new Map()\r\n    }\r\n\r\n    addMapping(code, callBack) {\r\n        this.keyMap.set(code, callBack)\r\n    }\r\n\r\n    handleEvent(event) {\r\n        const codeId = event.currentTarget.id;\r\n\r\n        if (!this.keyMap.has(codeId)) {\r\n            return;\r\n        }\r\n\r\n        event.preventDefault();\r\n\r\n        const keyState = (event.type === 'touchstart' || event.type === 'mousedown') ? PRESSED : RELEASED;\r\n\r\n        if (this.keyStates.get(codeId) === keyState) {\r\n            // avoid triggering multiple times\r\n            return;\r\n        }\r\n\r\n        this.keyStates.set(codeId, keyState);\r\n\r\n        this.keyMap.get(codeId)(keyState);\r\n    }\r\n\r\n    startListenTo() {\r\n        ['touchstart', 'touchend', 'mousedown', 'mouseup'].forEach(evtName => {\r\n            this.buttons.forEach(btn => {\r\n                btn.addEventListener(evtName, evt=> {\r\n                    this.handleEvent(evt);\r\n                })\r\n            })\r\n        })\r\n    }\r\n\r\n}\n/* harmony export (immutable) */ __webpack_exports__[\"a\"] = TouchPadState;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/input/TouchPadState.js\n// module id = 44\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/input/TouchPadState.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("/* harmony export (immutable) */ __webpack_exports__[\"a\"] = getUserAgent;\nfunction getPlatform(ua) {\r\n    if (/windows/i.test(ua)) {\r\n        return ['Windows', 0];\r\n    }\r\n\r\n    if (/android/i.test(ua)) {\r\n        const match = ua.match(/android\\s([0-9\\.]*)/i);\r\n        let ver = match ? parseFloat(match[1]) : 0;\r\n        return ['Android', ver];\r\n    }\r\n\r\n    // iOS detection from: http://stackoverflow.com/a/9039885/177710\r\n    if (/iP(hone|od|ad)/.test(ua) && !window.MSStream) {\r\n        const match = (navigator.appVersion).match(/OS (\\d+)_(\\d+)_?(\\d+)?/);\r\n        let ver = match ? parseInt(match[1], 10) : 0;\r\n        return ['iOS', ver];\r\n    }\r\n\r\n    if (ua.indexOf('Mac') > -1) {\r\n        return ['Mac', 0];\r\n    }\r\n\r\n    return ['unknown', 0];\r\n}\r\n\r\nfunction getUserAgent() {\r\n    let uaInfo = {};\r\n\r\n    const ua = navigator.userAgent;\r\n\r\n    // TODO Better Compatibility Detect\r\n    try {\r\n        [uaInfo.platform, uaInfo.ver] = getPlatform(ua);\r\n    } catch (err) {\r\n        [uaInfo.platform, uaInfo.ver] = ['Windows', 0];\r\n    }\r\n\r\n    // alert(uaInfo.platform, uaInfo.ver);\r\n\r\n    return uaInfo;\r\n}\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/polyfills/getUserAgent.js\n// module id = 45\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/polyfills/getUserAgent.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("/* harmony export (immutable) */ __webpack_exports__[\"a\"] = autoPlayOniOS;\nfunction autoPlayOniOS() {\r\n    const bgmAudioEl = document.getElementById('bgm');\r\n\r\n    function forceSafariAutoPlay() {\r\n        bgmAudioEl.load();\r\n        bgmAudioEl.play();\r\n    }\r\n\r\n    window.addEventListener('touchstart', forceSafariAutoPlay);\r\n\r\n    bgmAudioEl.addEventListener('play', () => {\r\n        console.log('BGM Played!');\r\n\r\n        window.removeEventListener('touchstart', forceSafariAutoPlay);\r\n    });\r\n}\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/polyfills/autoPlayOniOS.js\n// module id = 46\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/polyfills/autoPlayOniOS.js?")},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony export (immutable) */ __webpack_exports__["b"] = createPlayerEnv;\n/* harmony export (immutable) */ __webpack_exports__["a"] = createPlayer;\n/* unused harmony export findPlayers */\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__Entity_js__ = __webpack_require__(0);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__traits_Player_js__ = __webpack_require__(48);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_2__traits_PlayerController_js__ = __webpack_require__(49);\n\r\n\r\n\r\n\r\nfunction createPlayerEnv(playerEntity) {\r\n    const playerEnv = new __WEBPACK_IMPORTED_MODULE_0__Entity_js__["c" /* default */]();\r\n    const playerControl = new __WEBPACK_IMPORTED_MODULE_2__traits_PlayerController_js__["a" /* default */]();\r\n    // playerControl.checkpoint.set(64, 64);\r\n    playerControl.setPlayer(playerEntity);\r\n    playerEnv.addTrait(playerControl);\r\n    return playerEnv;\r\n}\r\n\r\nfunction createPlayer(entity) {\r\n    entity.addTrait(new __WEBPACK_IMPORTED_MODULE_1__traits_Player_js__["a" /* default */]());\r\n    return entity;\r\n}\r\n\r\nfunction* findPlayers(level) {\r\n    for (const entity of level.entities) {\r\n        if (entity.player) {\r\n            yield entity;\r\n        }\r\n    }\r\n}\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/player.js\n// module id = 47\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/player.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__Entity_js__ = __webpack_require__(0);\n\r\n\r\nclass Player extends __WEBPACK_IMPORTED_MODULE_0__Entity_js__["b" /* Trait */] {\r\n    constructor() {\r\n        super(\'player\');\r\n        this.lives = 3;\r\n        this.score = 0;\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = Player;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/traits/Player.js\n// module id = 48\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/traits/Player.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval('/* harmony import */ var __WEBPACK_IMPORTED_MODULE_0__Entity_js__ = __webpack_require__(0);\n/* harmony import */ var __WEBPACK_IMPORTED_MODULE_1__math_js__ = __webpack_require__(2);\n\r\n\r\n\r\nclass PlayerController extends __WEBPACK_IMPORTED_MODULE_0__Entity_js__["b" /* Trait */] {\r\n    constructor() {\r\n        super(\'playerController\');\r\n        this.player = null;\r\n        this.checkPoint = new __WEBPACK_IMPORTED_MODULE_1__math_js__["b" /* Vec2 */](4*16,12*16);\r\n        this.time = 300;\r\n        this.score = 0;\r\n    }\r\n\r\n    setPlayer(entity) {\r\n        this.player = entity;\r\n        // this.player.stomer.onStomp = () => {\r\n        //     this.score += 100;\r\n        // }\r\n        this.player.stomer.events.listen(\'stomp\', () => {\r\n            this.score += 100;\r\n        })\r\n    }\r\n\r\n    update(entity, { deltaTime }, level) {\r\n        if (!level.entities.has(this.player)) {\r\n            this.player.killable.revive();\r\n            this.player.pos.set(this.checkPoint.x ,this.checkPoint.y);\r\n            level.entities.add(this.player);\r\n        } else {\r\n            this.time -= deltaTime * 2;\r\n        }\r\n    }\r\n}\n/* harmony export (immutable) */ __webpack_exports__["a"] = PlayerController;\n\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/traits/PlayerController.js\n// module id = 49\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/traits/PlayerController.js?')},function(module,__webpack_exports__,__webpack_require__){"use strict";eval("/* harmony export (immutable) */ __webpack_exports__[\"a\"] = createWaitingLayer;\nfunction createWaitingLayer(font, logoImg) {\r\n    let showClickTip = 0\r\n    return function drawDashboard(context) {\r\n        context.drawImage(\r\n            logoImg,\r\n            30,\r\n            24,\r\n            200,\r\n            90\r\n        )\r\n        if (showClickTip <= 60) {\r\n            font.print('CLICK TO START', context, 76, 140);\r\n            showClickTip++\r\n        } else if (showClickTip > 90) {\r\n            showClickTip = 0\r\n        } else if (showClickTip > 60) {\r\n            showClickTip++\r\n        }\r\n    }\r\n}\r\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./public/js/layers/wating.js\n// module id = 50\n// module chunks = 0\n\n//# sourceURL=webpack:///./public/js/layers/wating.js?")}]);